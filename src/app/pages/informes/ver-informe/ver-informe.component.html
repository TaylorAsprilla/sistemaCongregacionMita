<div class="container-fluid py-4">
  <!-- Barra de acciones -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <button class="btn btn-secondary" (click)="volverAlInforme()">
      <i class="fa fa-arrow-left"></i> Volver al Informe
    </button>
    <button class="btn btn-primary" (click)="descargarPDF()" [disabled]="descargandoPDF || cargando">
      <i class="fa" [ngClass]="descargandoPDF ? 'fa-spinner fa-spin' : 'fa-download'"></i>
      {{ descargandoPDF ? 'Generando PDF...' : 'Descargar PDF' }}
    </button>
  </div>

  <!-- Spinner de carga -->
  @if (cargando) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem">
        <span class="sr-only">Cargando...</span>
      </div>
      <p class="mt-3 h5 text-muted">Cargando datos del informe...</p>
    </div>
  }

  <!-- Contenido del informe -->
  @if (!cargando) {
    <div #content class="informe-content bg-white p-5 shadow-sm">
      <!-- Encabezado -->
      <div class="text-center mb-4">
        <h2 class="font-weight-bold mb-3">Congregación Mita Inc.</h2>
        <h3 class="mb-4">Informe Trimestral</h3>

        <div class="info-box mx-auto" style="max-width: 600px">
          <table class="table table-bordered mb-0">
            <tr>
              <td class="font-weight-bold bg-light" style="width: 40%">Trimestre {{ anioTrimestre }}:</td>
              <td>{{ getOrdinalTrimestre() }} - {{ trimestre }}</td>
            </tr>
            <tr>
              <td class="font-weight-bold bg-light">Obrero/a:</td>
              <td>{{ nombreUsuario }}</td>
            </tr>
            <tr>
              <td class="font-weight-bold bg-light">Congregación País:</td>
              <td>{{ congregacionPais }}</td>
            </tr>
            <tr>
              <td class="font-weight-bold bg-light">Congregación Ciudad:</td>
              <td>{{ congregacionCiudad }}</td>
            </tr>
            <tr>
              <td class="font-weight-bold bg-light">Congregación Campo:</td>
              <td>{{ congregacionCampo }}</td>
            </tr>
            <tr>
              <td class="font-weight-bold bg-light">Fecha de Informe:</td>
              <td>{{ fechaActual | date: 'dd/MM/yyyy' }}</td>
            </tr>
          </table>
        </div>
      </div>

      <hr class="my-4" />

      <!-- A. Actividades Eclesiásticas -->
      <div class="seccion mb-5">
        <h4 class="seccion-titulo mb-3">A. ACTIVIDADES ECLESIÁSTICAS</h4>
        @if (actividadesEclesiasticas.length > 0) {
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="thead-light">
                <tr>
                  <th>Fecha</th>
                  <th>Tipo de Actividad</th>
                  <th>Responsable</th>
                  <th>Asistencia</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody>
                @for (actividad of actividadesEclesiasticas; track actividad.id) {
                  <tr>
                    <td>{{ actividad.fecha | date: 'dd/MM/yyyy' }}</td>
                    <td>{{ buscarNombreTipoActividad(actividad.tipoActividad_id) }}</td>
                    <td>{{ actividad.responsable }}</td>
                    <td>{{ actividad.asistencia || 0 }}</td>
                    <td>{{ actividad.observaciones || '-' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="alert alert-info">No se registraron actividades eclesiásticas en este trimestre.</div>
        }
      </div>

      <!-- B. Actividades Económicas -->
      <div class="seccion mb-5">
        <h4 class="seccion-titulo mb-3">B. ACTIVIDADES ECONÓMICAS</h4>
        @if (actividadesEconomicas.length > 0) {
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="thead-light">
                <tr>
                  <th>Fecha</th>
                  <th>Tipo de Actividad</th>
                  <th>Responsable</th>
                  <th>Cantidad Recaudada</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody>
                @for (actividad of actividadesEconomicas; track actividad.id) {
                  <tr>
                    <td>{{ actividad.fecha | date: 'dd/MM/yyyy' }}</td>
                    <td>{{ buscarNombreTipoActividadEconomica(actividad.tipoActividadEconomica_id) }}</td>
                    <td>{{ actividad.responsable }}</td>
                    <td>{{ actividad.cantidadRecaudada || 0 | currency: 'USD' : 'symbol' : '1.2-2' }}</td>
                    <td>{{ actividad.observaciones || '-' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="alert alert-info">No se registraron actividades económicas en este trimestre.</div>
        }
      </div>

      <!-- C. Visitas -->
      <div class="seccion mb-5">
        <h4 class="seccion-titulo mb-3">C. RESUMEN DE VISITAS REALIZADAS</h4>
        @if (visitas.length > 0) {
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="thead-light">
                <tr>
                  <th>Mes</th>
                  <th>Visitas Hogares</th>
                  <th>Referidas OOTS</th>
                  <th>Visitas Hospital</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody>
                @for (visita of visitas; track visita.id) {
                  <tr>
                    <td>{{ getNombreMes(visita.mes) }}</td>
                    <td>{{ visita.visitasHogares || 0 }}</td>
                    <td>{{ visita.referidasOots || 0 }}</td>
                    <td>{{ visita.visitaHospital || 0 }}</td>
                    <td>{{ visita.observaciones || '-' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="alert alert-info">No se registraron visitas en este trimestre.</div>
        }
      </div>

      <!-- D. Diezmos -->
      <div class="seccion mb-5">
        <h4 class="seccion-titulo mb-3">D. RESUMEN DE DIEZMOS</h4>
        @if (diezmos.length > 0) {
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="thead-light">
                <tr>
                  <th>Mes</th>
                  <th>Sobres Restrictos</th>
                  <th>Sobres No Restrictos</th>
                  <th>Restrictos ($)</th>
                  <th>No Restrictos ($)</th>
                  <th>Total ($)</th>
                </tr>
              </thead>
              <tbody>
                @for (diezmo of diezmos; track diezmo.id) {
                  <tr>
                    <td>{{ getNombreMes(diezmo.mes) }}</td>
                    <td>{{ diezmo.sobresRestrictos || 0 }}</td>
                    <td>{{ diezmo.sobresNoRestrictos || 0 }}</td>
                    <td>{{ diezmo.restrictos || 0 | number: '1.2-2' }}</td>
                    <td>{{ diezmo.noRestrictos || 0 | number: '1.2-2' }}</td>
                    <td>{{ (diezmo.restrictos || 0) + (diezmo.noRestrictos || 0) | number: '1.2-2' }}</td>
                  </tr>
                }
                <tr class="font-weight-bold bg-light">
                  <td>TOTAL</td>
                  <td>{{ calcularTotal(diezmos, 'sobresRestrictos') }}</td>
                  <td>{{ calcularTotal(diezmos, 'sobresNoRestrictos') }}</td>
                  <td>{{ calcularTotal(diezmos, 'restrictos') | number: '1.2-2' }}</td>
                  <td>{{ calcularTotal(diezmos, 'noRestrictos') | number: '1.2-2' }}</td>
                  <td>
                    {{
                      calcularTotal(diezmos, 'restrictos') + calcularTotal(diezmos, 'noRestrictos') | number: '1.2-2'
                    }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        } @else {
          <div class="alert alert-info">No se registraron diezmos en este trimestre.</div>
        }
      </div>

      <!-- E. Situación en las Visitas -->
      <div class="seccion mb-5">
        <h4 class="seccion-titulo mb-3">E. SITUACIONES ENCONTRADAS DURANTE LAS VISITAS</h4>
        @if (situacionVisitas.length > 0) {
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="thead-light">
                <tr>
                  <th>Fecha</th>
                  <th>Nombre Feligrés</th>
                  <th>Situación</th>
                  <th>Intervención</th>
                  <th>Seguimiento</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody>
                @for (situacion of situacionVisitas; track situacion.id) {
                  <tr>
                    <td>{{ situacion.fecha | date: 'dd/MM/yyyy' }}</td>
                    <td>{{ situacion.nombreFeligres }}</td>
                    <td>{{ situacion.situacion || '-' }}</td>
                    <td>{{ situacion.intervension || '-' }}</td>
                    <td>{{ situacion.seguimiento || '-' }}</td>
                    <td>{{ situacion.observaciones || '-' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="alert alert-info">No se registraron situaciones de visitas en este trimestre.</div>
        }
      </div>

      <!-- F. Logros Obtenidos -->
      <div class="seccion mb-5">
        <h4 class="seccion-titulo mb-3">F. LOGROS OBTENIDOS</h4>
        @if (logros.length > 0) {
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="thead-light">
                <tr>
                  <th>Logro</th>
                  <th>Responsable</th>
                  <th>Observaciones</th>
                </tr>
              </thead>
              <tbody>
                @for (logro of logros; track logro.id) {
                  <tr>
                    <td>{{ logro.logro }}</td>
                    <td>{{ logro.responsable }}</td>
                    <td>{{ logro.comentarios || '-' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="alert alert-info">No se registraron logros en este trimestre.</div>
        }
      </div>

      <!-- G. Metas para el Próximo Trimestre -->
      <div class="seccion mb-5">
        <h4 class="seccion-titulo mb-3">G. METAS PARA EL PRÓXIMO TRIMESTRE</h4>
        @if (metas.length > 0) {
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="thead-light">
                <tr>
                  <th>Meta</th>
                  <th>Fecha</th>
                  <th>Acción</th>
                  <th>Comentarios</th>
                </tr>
              </thead>
              <tbody>
                @for (meta of metas; track meta.id) {
                  <tr>
                    <td>{{ meta.meta }}</td>
                    <td>{{ meta.fecha | date: 'dd/MM/yyyy' }}</td>
                    <td>{{ meta.accion || '-' }}</td>
                    <td>{{ meta.comentarios || '-' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="alert alert-info">No se registraron metas para el próximo trimestre.</div>
        }
      </div>

      <!-- Pie de página -->
      <hr class="my-4" />
      <div class="footer-info text-muted">
        <p><strong>Informe generado por:</strong> {{ nombreUsuario }}</p>
        <p><strong>Fecha de generación:</strong> {{ fechaActual | date: 'dd/MM/yyyy HH:mm' }}</p>
      </div>
    </div>
  }
</div>
